<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Iris pull requests</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery.js"></script>
    <link href="github.css" media="screen" rel="stylesheet" type="text/css" /></link>
    <link href="github2.css" media="screen" rel="stylesheet" type="text/css" /></link>
    <style>
        #loading {
            width: 440px;
        }
        img.avatar {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body style="margin: 1em">
<script>
function render_user(user) {
    result = '-';
    if (user) {
        result = [
            $('<img class="avatar" src="' + user.avatar_url + '">'),
            ' ' + user.login
        ];
    }
    return result
}

function user_container(row) {
    cell = $('<td/>');
    ul = $('<ul class="fieldpills usernames"/>');
    li_empty = $('<li style="display: none"/>');
    li = $('<li/>');
    ul.append([li_empty, li]);
    cell.append(ul);
    row.append(cell);
    return li;
}

function show_pulls(pulls) {
    if (pulls.length > 0) {
        var reviewer_regex = /reviewer\s*:\s*(\w+)/i;
        var len = pulls.length;
        var target = $('#target');
        for(var i=0; i < len; i++) {
            var pull = pulls[i];
            row = $('<tr class="list-browser-item"/>')
            row.append('<td class="number">#' + pull.number + '</td>');
            row.append('<td><h3><a href="' + pull.html_url + '">' + pull.title + '</a></h3></td>');
            // Author
            container = user_container(row);
            container.append(render_user(pull.user));
            var reviewer = reviewer_regex.exec(pull.body);
            if(reviewer != null) {
                // Review with mentor
                container = user_container(row);
                container.append(reviewer[1]);
                container = user_container(row);
                if(pull.assignee) {
                    container.append(render_user(pull.assignee));
                } else {
                    container.append('- needs mentor -');
                }
                row.append(cell);
            } else if (pull.assignee) {
                // Normal review
                container = user_container(row);
                container.append(render_user(pull.assignee));
            }
            target.append(row);
        }
    }
}

$.ajax({
    type: 'GET',
    url: 'https://api.github.com/repos/SciTools/iris/pulls?callback=foo',
    jsonpCallback: 'foo',
    contentType: 'application/json',
    dataType: 'jsonp',
}).done(function(response) {
    show_pulls(response.data);
}).fail(function(request, status, error) {
    alert(JSON.stringify(request) + status + error);
});
</script>
<div class="issues-list">
    <table style="width: auto" id="target">
        <tr><th colspan="5"><h2>Iris pull requests</th></tr>
        <tr>
            <th>#</th>
            <th>Title</th>
            <th>Author</th>
            <th>Reviewer</th>
            <th>Mentor</th>
        </tr>
        <tr><td colspan="5" id="loading">Loading ...</td></tr>
    </table>
</div>
</body>
</html>
